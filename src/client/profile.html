<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Xat Recreation</title>
    <style>
        body, html {
            width: 100%;
            height: 100%;
            margin: 0px;
            padding: 0px;
            background-color: #000000;
            font-family: Arial, sans-serif;
        }

        .siteWrapper {
            min-height: 100vh;
        }

        .siteHeader {
            width: 100%;
            height: 60px;
            background: linear-gradient(to bottom, #333333, #222222);
            border-bottom: 2px solid #0066ff;
        }

        .center {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            float: left;
            display: block;
            width: 120px;
            height: 40px;
            margin: 10px 0;
            background: linear-gradient(45deg, #0066ff, #00ccff);
            border-radius: 5px;
            text-decoration: none;
            text-align: center;
            line-height: 40px;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .navigation {
            float: right;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .navigation li {
            display: inline-block;
            position: relative;
        }

        .navigation a {
            display: block;
            padding: 15px 20px;
            color: #cccccc;
            text-decoration: none;
            font-size: 13px;
            text-align: center;
            transition: color 0.3s;
        }

        .navigation a:hover {
            color: #ffffff;
        }

        .navigation a strong {
            display: block;
            font-size: 14px;
            font-weight: bold;
        }

        .navigation a span {
            display: block;
            font-size: 11px;
            opacity: 0.8;
        }

        .block {
            display: inline-block;
            vertical-align: top;
            margin: 0.5%;
            padding: 0.5%;
            border: 3px solid #0066ff;
            font-size: 13px;
            word-wrap: break-word;
            font-family: Arial;
            background: #111111;
        }

        .block.c3 { width: 31.3%; }
        .block.c5 { width: 18%; }
        .block.c4-5 { width: 72%; }
        .block.fr { float: right; }

        .heading {
            display: inline-block;
            font-size: 16px;
            width: 100%;
            border-bottom: 2px solid #ffffff;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .tc { text-align: center; }
        .tr { text-align: right; }
        .tl { text-align: left; }
        .pnt { cursor: pointer; }
        .hus:hover { text-decoration: underline; }

        input[type="text"], input[type="password"], input[type="email"], textarea {
            border: 1px solid #adaba3;
            padding: 2px 2px;
            text-align: center;
            background: #222222;
            color: #ffffff;
        }

        input[type="submit"] {
            border: 1px solid #adaba3;
            padding: 1px 6px;
            text-align: center;
            background-color: #f0f0f0;
            cursor: pointer;
            margin-left: -6px;
            margin-right: -6px;
        }

        input[type="submit"]:hover {
            background-color: #e0e0e0;
        }

        table {
            width: 100%;
            color: #ffffff;
        }

        table td {
            padding: 5px;
        }

        .message {
            width: 98%;
            padding: 0.5% 1%;
            background-color: #000000;
            font-size: 13px;
            color: #ffffff;
            font-family: Arial;
            text-align: center;
            margin-bottom: 5px;
            border: 1px solid #0066ff;
        }

        .siteFooterBar {
            background: #222222;
            border-top: 2px solid #0066ff;
            padding: 20px 0;
            margin-top: 40px;
        }

        .backToTop {
            color: #0066ff;
            text-decoration: none;
            font-weight: bold;
        }

        .profile-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .profile-sidebar {
            flex: 0 0 300px;
        }

        .profile-main {
            flex: 1;
        }

        .custom-pawn-preview {
            width: 50px;
            height: 50px;
            border: 2px solid #0066ff;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 24px;
        }
    </style>
</head>
<body>
    <!-- Site Wrapper Start -->
    <div class="siteWrapper">
        <!-- Site Header -->
        <div class="siteHeader">
            <div class="center">
                <a class="logo" href="/">XAT</a>
                <ul class="navigation">
                    <li><a href="/"><strong>Home</strong><br><span>Main-Chat</span></a></li>
                    <li><a href="/powers.html"><strong>Powers</strong><br><span>Buy Powers!</span></a></li>
                    <li><a href="/trade.html"><strong>Trade</strong><br><span>Sell/List Powers</span></a></li>
                    <li><a href="/groups.html"><strong>Groups</strong><br><span>Edit Group/Create</span></a></li>
                    <li><a href="/profile.html" style="color: #ffffff;"><strong>Profile</strong><br><span>Register/Login!</span></a></li>
                    <li><a href="/donate.html"><strong>Donate</strong><br><span>Support us!</span></a></li>
                </ul>
            </div>
        </div>

        <br>
        <br>
        <br>
        <br>
        <br>
        <br>

        <center>
            <div id="main">
                <div id="messages"></div>
                
                <div id="profile-content">
                    <!-- Login/Register Form (shown when not logged in) -->
                    <div id="auth-forms" style="width: 100%;text-align: center;">
                        <div class="block c3 tl">
                            <div class="heading">Login to your account</div>
                            <table style="width: 99%">
                                <form id="login-form">
                                    <tr>
                                        <td class="tl">Username</td>
                                        <td><input style="width: 100%" type="text" name="user" required autocomplete="username" /></td>
                                    </tr>
                                    <tr>
                                        <td class="tl">Password</td>
                                        <td><input style="width: 100%" type="password" name="pass" required autocomplete="current-password" /></td>
                                    </tr>
                                    <tr>
                                        <td colspan="2"><input type="submit" value="Login" class="fr" /></td>
                                    </tr>
                                </form>
                            </table>
                            <div style="text-align: center; margin-top: 10px;">
                                <a href="#" onclick="showForgotPassword()" style="color: #0066ff; text-decoration: none; font-size: 12px;">Forgot Password?</a>
                            </div>
                        </div>
                        
                        <!-- Forgot Password Form -->
                        <div id="forgot-password-form" class="block c3 tl" style="display: none;">
                            <div class="heading">Reset Password</div>
                            <table style="width: 99%">
                                <form id="forgot-form">
                                    <tr>
                                        <td class="tl">Email</td>
                                        <td><input style="width: 100%" type="email" name="email" required autocomplete="email" /></td>
                                    </tr>
                                    <tr>
                                        <td colspan="2"><input type="submit" value="Send Reset Email" class="fr" /></td>
                                    </tr>
                                </form>
                            </table>
                            <div style="text-align: center; margin-top: 10px;">
                                <a href="#" onclick="hideForgotPassword()" style="color: #0066ff; text-decoration: none; font-size: 12px;">Back to Login</a>
                            </div>
                        </div>
                        
                        <div style="width: 10%; display: inline-block;"><!-- Spacer --></div>
                        
                        <div class="block c3 tl">
                            <div class="heading">Register for an account</div>
                            <table style="width: 99%">
                                <form id="register-form">
                                    <tr>
                                        <td class="tl">Username</td>
                                        <td><input style="width: 100%" type="text" name="user" required autocomplete="username" /></td>
                                    </tr>
                                    <tr>
                                        <td class="tl">Nickname</td>
                                        <td><input style="width: 100%" type="text" name="nickname" required autocomplete="nickname" /></td>
                                    </tr>
                                    <tr>
                                        <td class="tl">Password</td>
                                        <td><input style="width: 100%" type="password" name="pass" required autocomplete="new-password" /></td>
                                    </tr>
                                    <tr>
                                        <td class="tl">Email</td>
                                        <td><input style="width: 100%" type="email" name="mail" required autocomplete="email" /></td>
                                    </tr>
                                    <tr>
                                        <td colspan="2"><input type="submit" value="Register" class="fr" /></td>
                                    </tr>
                                </form>
                            </table>
                        </div>
                    </div>

                    <!-- Profile Content (shown when logged in) -->
                    <div id="profile-info" style="display: none;">
                        <div class="profile-container">
                            <div class="profile-sidebar">
                                <div class="block c5">
                                    <div class="heading" id="profile-nickname">Loading...</div>
                                    <table style="width: 99%">
                                        <tr>
                                            <td>Xats</td>
                                            <td class="tr" id="profile-xats">0</td>
                                        </tr>
                                        <tr>
                                            <td>Days</td>
                                            <td class="tr" id="profile-days">0</td>
                                        </tr>
                                        <tr>
                                            <td>Powers</td>
                                            <td class="tr" id="profile-powers">0</td>
                                        </tr>
                                        <tr>
                                            <td>Credit</td>
                                            <td class="tr" id="profile-credit">0</td>
                                        </tr>
                                    </table>
                                    <div style="width: 100%" class="tc">
                                        <input type="submit" class="claimCredit" value="Claim Credit" onclick="claimCredit()" />
                                        &nbsp;&nbsp;&nbsp;&nbsp;
                                        <input type="submit" class="relogin" value="Relogin" onclick="relogin()" />
                                        &nbsp;&nbsp;&nbsp;&nbsp;
                                        <input type="submit" class="logout" value="Logout" onclick="logout()" style="background: #dc3545; color: white;" />
                                    </div>
                                </div>
                            </div>
                            
                            <div class="profile-main">
                                <div class="block c4-5 fr">
                                    <div class="heading">Custom Pawn <small style="font-size: 10px">[Hex 6 characters example: #000000, just type "off" to turn your custom pawn off]</small></div>
                                    <form id="pawn-form">
                                        <input style="width: 99%;text-align: center;" type="text" autocomplete="off" name="update_pawn" id="custom-pawn-input" value="off" />
                                        <div style="width: 99%;text-align: center">
                                            <input type="submit" value="Update" />
                                        </div>
                                    </form>
                                    <div class="custom-pawn-preview" id="pawn-preview">😎</div>
                                    
                                    <div class="heading">Referral Link <a href="/faq#referrals">(click for explanation)</a></div>
                                    <input type="text" style="width: 99%;text-align: center;" id="referral-link" value="Loading..." readonly />
                                    <br />
                                    <br />
                                    
                                    <div class="heading">Bio [ <a href="#" id="bio-preview-link">Preview</a> ]</div>
                                    <div id="bio-edit">
                                        <small style="cursor:pointer" title="[br], [center], [b], [h1], [h2], [h3]">BB CODES (hover)</small>
                                        <form id="bio-form">
                                            <textarea name="bio" id="bio-textarea" style="width: 99%;resize: none" rows="15"></textarea>
                                            <div style="width: 99%;text-align: center">
                                                <input type="submit" value="Update" />
                                            </div>
                                        </form>
                                    </div>
                                    <div id="bio-display" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </center>
    </div>

    <!-- Site Footer -->
    <div class="siteFooterBar">
        <div class="center">
            <center>
                <a class="backToTop" href="#">xat-recreation.com</a>
                <p style="color: #cccccc; margin-top: 10px;">Complete Xat recreation with all 325+ authentic powers</p>
            </center>
        </div>
    </div>

    <script>
        let currentUser = null;
        let isPreviewMode = false;

        // Check authentication status
        async function checkAuth() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/auth/status' + (token ? `?token=${token}` : ''));
                const data = await response.json();
                
                if(data.authenticated) {
                    currentUser = data.user;
                    showProfile();
                    loadUserProfile();
                } else {
                    showAuthForms();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                showAuthForms();
            }
        }

        function showAuthForms() {
            document.getElementById('auth-forms').style.display = 'block';
            document.getElementById('profile-info').style.display = 'none';
        }

        function showProfile() {
            document.getElementById('auth-forms').style.display = 'none';
            document.getElementById('profile-info').style.display = 'block';
        }
        
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userData');
            showAuthForms();
        }

        async function loadUserProfile() {
            if(!currentUser) return;
            
            try {
                const response = await fetch(`/api/user/${currentUser.id}`);
                const data = await response.json();
                
                if(data.success) {
                    const user = data.user;
                    document.getElementById('profile-nickname').textContent = user.nickname || user.username;
                    document.getElementById('profile-xats').textContent = user.xats;
                    document.getElementById('profile-days').textContent = Math.floor(user.days / 86400);
                    document.getElementById('profile-powers').textContent = data.powerCount || 0;
                    document.getElementById('profile-credit').textContent = user.credit || 0;
                    
                    // Set custom pawn
                    const pawnInput = document.getElementById('custom-pawn-input');
                    const pawnPreview = document.getElementById('pawn-preview');
                    if(user.custpawn && user.custpawn !== 'off') {
                        pawnInput.value = '#' + user.custpawn;
                        pawnPreview.style.backgroundColor = '#' + user.custpawn;
                        pawnPreview.textContent = '😎';
                    } else {
                        pawnInput.value = 'off';
                        pawnPreview.style.backgroundColor = 'transparent';
                        pawnPreview.textContent = '😎';
                    }
                    
                    // Set bio
                    document.getElementById('bio-textarea').value = user.desc || '';
                    
                    // Set referral link
                    document.getElementById('referral-link').value = `${window.location.origin}/?ref=${user.id}`;
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
            }
        }

        // Form handlers
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: formData.get('user'),
                        password: formData.get('pass')
                    })
                });

                const result = await response.json();
                
                if(result.success) {
                    // Store token in localStorage
                    localStorage.setItem('authToken', result.token);
                    localStorage.setItem('userData', JSON.stringify(result.user));
                    showMessage('Login successful!');
                    checkAuth();
                } else {
                    showMessage(result.message || 'Login failed');
                }
            } catch (error) {
                console.error('Login failed:', error);
                showMessage('Login failed');
            }
        });

        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: formData.get('user'),
                        nickname: formData.get('nickname'),
                        password: formData.get('pass'),
                        email: formData.get('mail')
                    })
                });

                const result = await response.json();
                
                if(result.success) {
                    // Store token in localStorage
                    localStorage.setItem('authToken', result.token);
                    localStorage.setItem('userData', JSON.stringify(result.user));
                    showMessage('Registration successful, you may now login');
                    this.reset();
                    checkAuth(); // Auto-login after registration
                } else {
                    showMessage(result.message || 'Registration failed');
                }
            } catch (error) {
                console.error('Registration failed:', error);
                showMessage('Registration failed');
            }
        });

        document.getElementById('pawn-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const pawn = formData.get('update_pawn');
            
            try {
                const response = await fetch('/api/user/pawn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ pawn: pawn })
                });

                const result = await response.json();
                
                if(result.success) {
                    showMessage('Custom pawn updated!');
                    loadUserProfile();
                } else {
                    showMessage(result.message || 'Failed to update pawn');
                }
            } catch (error) {
                console.error('Pawn update failed:', error);
                showMessage('Failed to update pawn');
            }
        });

        document.getElementById('bio-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const bio = formData.get('bio');
            
            try {
                const response = await fetch('/api/user/bio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ bio: bio })
                });

                const result = await response.json();
                
                if(result.success) {
                    showMessage('Bio updated!');
                } else {
                    showMessage(result.message || 'Failed to update bio');
                }
            } catch (error) {
                console.error('Bio update failed:', error);
                showMessage('Failed to update bio');
            }
        });

        // Custom pawn preview
        document.getElementById('custom-pawn-input').addEventListener('input', function(e) {
            const value = e.target.value;
            const preview = document.getElementById('pawn-preview');
            
            if(value && value !== 'off' && value.match(/^#[0-9A-Fa-f]{6}$/)) {
                preview.style.backgroundColor = value;
            } else {
                preview.style.backgroundColor = 'transparent';
            }
        });

        // Bio preview toggle
        document.getElementById('bio-preview-link').addEventListener('click', function(e) {
            e.preventDefault();
            isPreviewMode = !isPreviewMode;
            
            if(isPreviewMode) {
                const bio = document.getElementById('bio-textarea').value;
                const display = document.getElementById('bio-display');
                display.innerHTML = formatBio(bio);
                document.getElementById('bio-edit').style.display = 'none';
                document.getElementById('bio-display').style.display = 'block';
                this.textContent = 'Edit';
            } else {
                document.getElementById('bio-edit').style.display = 'block';
                document.getElementById('bio-display').style.display = 'none';
                this.textContent = 'Preview';
            }
        });

        function formatBio(bio) {
            const bb = {
                '[br]': '<br />',
                '\n': '<br />',
                '[center]': '<span class="tc" style="width: 100%;display: inline-block;">',
                '[/center]': '</span>',
                '[b]': '<b>',
                '[/b]': '</b>',
                '[h1]': '<h1>',
                '[/h1]': '</h1>',
                '[h2]': '<h2>',
                '[/h2]': '</h2>',
                '[h3]': '<h3>',
                '[/h3]': '</h3>'
            };
            
            return bio.replace(/\[br\]|\n|\[center\]|\[\/center\]|\[b\]|\[\/b\]|\[h1\]|\[\/h1\]|\[h2\]|\[\/h2\]|\[h3\]|\[\/h3\]/g, function(match) {
                return bb[match] || match;
            });
        }

        async function claimCredit() {
            try {
                const response = await fetch('/api/user/claim-credit', { method: 'POST' });
                const result = await response.json();
                
                if(result.success) {
                    showMessage('Credit claimed successfully!');
                    loadUserProfile();
                } else {
                    showMessage(result.message || 'Failed to claim credit');
                }
            } catch (error) {
                console.error('Claim credit failed:', error);
                showMessage('Failed to claim credit');
            }
        }

        async function relogin() {
            try {
                const response = await fetch('/api/auth/relogin', { method: 'POST' });
                const result = await response.json();
                
                if(result.success) {
                    showMessage('Relogin successful!');
                    checkAuth();
                } else {
                    showMessage(result.message || 'Relogin failed');
                }
            } catch (error) {
                console.error('Relogin failed:', error);
                showMessage('Relogin failed');
            }
        }

        function showMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Forgot Password Functions
        function showForgotPassword() {
            document.getElementById('auth-forms').style.display = 'none';
            document.getElementById('forgot-password-form').style.display = 'inline-block';
        }

        function hideForgotPassword() {
            document.getElementById('forgot-password-form').style.display = 'none';
            document.getElementById('auth-forms').style.display = 'block';
        }

        // Handle forgot password form submission
        document.getElementById('forgot-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const email = formData.get('email');
            
            try {
                const response = await fetch('/api/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });
                
                const result = await response.json();
                
                if(result.success) {
                    showMessage('Password reset email sent! Check your inbox.');
                    hideForgotPassword();
                } else {
                    showMessage(result.message || 'Failed to send reset email');
                }
            } catch (error) {
                console.error('Forgot password failed:', error);
                showMessage('Failed to send reset email');
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });
    </script>
</body>
</html>
